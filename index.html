<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Boggi League</title>
  <style>
    :root {
      /* Palette ispirata a Boggi: navy + beige chiaro */
      --bg: #020713;
      --bg2: #071226;
      --card: rgba(7, 18, 38, 0.92);
      --glass-soft: rgba(12, 26, 56, 0.88);
      --text: #f0eee4;
      --muted: #b4bccb;
      --accent: #f0eee4;
      --accent2: #c5a48c;
      --good: #7ac48d;
      --bad: #ff7b7f;
      --sep: rgba(255, 255, 255, 0.18);
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      --radius: 16px;
      --radius-sm: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: radial-gradient(circle at top, #0a1631 0, var(--bg) 55%, #01030a 100%);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 90px;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: calc(10px + env(safe-area-inset-top)) 18px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(24px) saturate(200%);
      background: linear-gradient(180deg, #030915, #050d20);
      border-bottom: 1px solid var(--sep);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.65);
    }
    .title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.28px;
      text-transform: uppercase;
      color: var(--accent);
    }
    .subtitle {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.1px;
    }

    main { padding: 16px 16px 100px; }
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.25s; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(4px);} to{opacity:1;transform:translateY(0);} }

    /* CLASSIFICA */
    .search-bar { margin-bottom: 14px; }
    .search-bar input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid var(--sep);
      background: rgba(3, 10, 23, 0.9);
      color: var(--text);
      font-size: 14px;
    }
    .search-bar input::placeholder { color: var(--muted); }

    .podium {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .podium-card {
      border-radius: var(--radius);
      padding: 12px 10px;
      text-align: center;
      background: radial-gradient(circle at top, rgba(240,238,228,0.14), rgba(1,3,10,0.9));
      border: 1px solid var(--sep);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .podium-card.first { border-color: var(--accent2); }
    .podium-card.second { opacity: 0.96; }
    .podium-card.third { opacity: 0.96; }
    .podium-medal { font-size: 24px; margin-bottom: 6px; }
    .podium-name { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
    .podium-points { font-size: 18px; font-weight: 800; color: var(--accent); }
    .podium-stats { font-size: 11px; color: var(--muted); }

    .table-wrap {
      background: rgba(5, 13, 29, 0.96);
      border-radius: var(--radius);
      border: 1px solid var(--sep);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: var(--shadow);
    }
    table.stats-table {
      width: 100%;
      min-width: 720px;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th {
      background: linear-gradient(180deg, #071329, #050e21);
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.4px;
      padding: 10px 6px;
      border-bottom: 1px solid var(--sep);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    tbody td {
      padding: 9px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
    }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.015); }
    tbody tr:hover { background: rgba(240,238,228,0.05); }
    tbody td:first-child { font-weight: 700; color: var(--muted); }
    .player-cell { font-weight: 700; cursor: pointer; }
    .player-cell span {
      border-radius: 999px;
      padding: 3px 7px;
      background: rgba(240,238,228,0.06);
    }

    /* Su schermi piccoli nascondi colonne secondarie per rendere la classifica pi√π chiara */
    @media (max-width: 480px) {
      table.stats-table { font-size: 12px; min-width: 0; }
      thead th:nth-child(5),
      thead th:nth-child(6),
      thead th:nth-child(8),
      thead th:nth-child(9),
      thead th:nth-child(10),
      tbody td:nth-child(5),
      tbody td:nth-child(6),
      tbody td:nth-child(8),
      tbody td:nth-child(9),
      tbody td:nth-child(10) {
        display: none;
      }
    }

    /* PARTITE */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }
    .top-row-title { font-size: 15px; font-weight: 600; color: var(--muted); }
    .pill-button {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid var(--sep);
      background: rgba(5, 13, 27, 0.96);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .cards { display: flex; flex-direction: column; gap: 14px; }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--sep);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    /* Scoreboard stile Serie A + Boggi */
    .scoreboard {
      border-radius: 14px;
      padding: 10px 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: linear-gradient(90deg, #050f22 0%, #071a34 50%, #050f22 100%);
      border: 1px solid rgba(240,238,228,0.28);
      box-shadow: 0 10px 24px rgba(0,0,0,0.7);
    }
    .scoreboard.w-b { box-shadow: 0 10px 26px rgba(122,196,141,0.45); }
    .scoreboard.w-c { box-shadow: 0 10px 26px rgba(255,123,127,0.45); }
    .sb-side {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .sb-team-name {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #f0eee4;
    }
    .sb-team-name.right { text-align: right; }
    .sb-center {
      min-width: 110px;
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 6px;
    }
    .sb-score {
      font-size: 26px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
    }
    .sb-score.b { color: var(--good); }
    .sb-score.c { color: var(--bad); }
    .sb-sep {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      opacity: 0.8;
    }

    .giornata-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .team-col-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .player-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: var(--radius-sm);
      background: rgba(3,8,18,0.9);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
    }
    .player-name { font-weight: 600; }
    .goal-badge {
      min-width: 22px;
      text-align: center;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(240,238,228,0.14);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .card-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .small-btn {
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid var(--sep);
      background: rgba(3,8,18,0.9);
      color: var(--muted);
      cursor: pointer;
    }

    .bottombar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 200;
      display: flex;
      gap: 10px;
      padding: 8px 16px calc(8px + env(safe-area-inset-bottom));
      backdrop-filter: blur(22px) saturate(220%);
      background: linear-gradient(180deg, rgba(3,8,18,0.4), rgba(1,3,8,0.98));
      border-top: 1px solid var(--sep);
      box-shadow: 0 -10px 30px rgba(0,0,0,0.7);
    }
    .tab {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--sep);
      background: rgba(240,238,228,0.05);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      padding: 9px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .tab.active {
      background: linear-gradient(135deg, #f0eee4, #c5a48c);
      color: #020713;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.7);
    }

    .modal {
      position: fixed;
      inset: 0;
      z-index: 300;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
    }
    .modal-sheet {
      position: relative;
      width: 100%;
      max-width: 520px;
      border-radius: 18px 18px 0 0;
      background: linear-gradient(180deg, #040b19, #020713);
      border-top: 1px solid rgba(240,238,228,0.26);
      box-shadow: 0 -18px 40px rgba(0,0,0,0.9);
      padding: 12px 16px 14px;
    }
    .modal-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: rgba(240,238,228,0.35);
      margin: 2px auto 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title { font-size: 16px; font-weight: 700; }
    .modal-sub { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      padding: 4px;
      cursor: pointer;
    }
    .modal-giornata-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--accent2);
    }
    .modal-teams {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal-team {
      background: rgba(3,8,18,0.95);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(240,238,228,0.25);
      padding: 8px;
    }
    .modal-team .team-col-title { margin-bottom: 4px; }
    .modal-rows {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 160px;
      overflow-y: auto;
    }
    .modal-row {
      display: grid;
      grid-template-columns: 1fr 54px auto;
      gap: 6px;
      align-items: center;
    }
    .modal-row select,
    .modal-row input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(240,238,228,0.3);
      background: rgba(2,7,19,0.9);
      color: var(--text);
      font-size: 12px;
      padding: 5px 8px;
    }
    .modal-row input { text-align: center; }
    .modal-row button {
      border-radius: 999px;
      border: 1px solid rgba(240,238,228,0.28);
      background: rgba(240,238,228,0.05);
      color: var(--muted);
      font-size: 12px;
      padding: 4px 6px;
      cursor: pointer;
    }
    .modal-autogol {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal-autogol label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .modal-autogol input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(240,238,228,0.3);
      background: rgba(2,7,19,0.9);
      color: var(--text);
      font-size: 12px;
      padding: 5px 8px;
      text-align: center;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }
    .btn-secondary,
    .btn-primary {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--sep);
    }
    .btn-secondary {
      background: rgba(240,238,228,0.05);
      color: var(--muted);
    }
    .btn-primary {
      background: linear-gradient(135deg, #f0eee4, #c5a48c);
      border-color: transparent;
      color: #020713;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div>
      <div class="title">Boggi League</div>
      <div class="subtitle">Classifica & partite 5vs5, stile Boggi</div>
    </div>
  </header>

  <main>
    <!-- CLASSIFICA -->
    <section id="classificaView" class="view active">
      <div class="search-bar">
        <input id="searchPlayer" type="search" placeholder="üîç Cerca o tocca un nome per rinominarlo‚Ä¶" />
      </div>

      <div id="podium" class="podium"></div>

      <div class="table-wrap">
        <table class="stats-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Giocatore</th>
              <th>PTF</th>
              <th>PT</th>
              <th>MPP</th>
              <th>MGP</th>
              <th>PG</th>
              <th>V</th>
              <th>N</th>
              <th>P</th>
              <th>GF</th>
              <th>GS</th>
              <th>DR</th>
            </tr>
          </thead>
          <tbody id="classificaBody"></tbody>
        </table>
      </div>
    </section>

    <!-- PARTITE -->
    <section id="partiteView" class="view">
      <div class="top-row">
        <div class="top-row-title">Partite per giornata (5vs5)</div>
        <button class="pill-button" id="btnNuovaGiornata">
          <span>‚ûï</span>Nuova giornata
        </button>
      </div>
      <div id="partiteContainer" class="cards"></div>
    </section>
  </main>

  <nav class="bottombar">
    <button class="tab active" data-view="classificaView">üèÜ Classifica</button>
    <button class="tab" data-view="partiteView">‚öΩ Partite</button>
  </nav>

  <!-- MODAL EDITOR GIORNATA -->
  <div id="matchModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Nuova giornata</div>
        <button class="modal-close" id="modalClose">‚úï</button>
      </div>
      <div class="modal-sub">Seleziona 5 giocatori per squadra: nessun nome pu√≤ essere ripetuto.</div>

      <div class="modal-giornata-label">
        Giornata <span id="modalGiornataNum"></span> ‚Ä¢ 5vs5
      </div>

      <div class="modal-teams">
        <div class="modal-team">
          <div class="team-col-title">Bianchi</div>
          <div id="modalBianchiRows" class="modal-rows"></div>
        </div>
        <div class="modal-team">
          <div class="team-col-title">Colorati</div>
          <div id="modalColoratiRows" class="modal-rows"></div>
        </div>
      </div>

      <div class="modal-autogol">
        <div>
          <label>Auto gol Bianchi</label>
          <input id="modalAutoB" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Auto gol Colorati</label>
          <input id="modalAutoC" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="modal-footer">
        <button id="modalCancel" class="btn-secondary">Annulla</button>
        <button id="modalSave" class="btn-primary">Salva</button>
      </div>
    </div>
  </div>

  <script>
    // --- DATI INIZIALI: 9 giornate (prime 8 dall'Excel + 9¬™ dal tuo screenshot) ---
    const initialData = {
      giornate: [
        {
          giornata: 1,
          bianchi: [
            { player: "GIAN PIERO", goals: 2 },
            { player: "LUCA", goals: 4 },
            { player: "EMANUELE", goals: 4 },
            { player: "MARCO", goals: 0 },
            { player: "GIANLUCA", goals: 3 }
          ],
          colorati: [
            { player: "BRIAN", goals: 2 },
            { player: "STEFANO", goals: 0 },
            { player: "CAIO", goals: 2 },
            { player: "PIERFRANCESCO", goals: 2 },
            { player: "LUIGI", goals: 1 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 2,
          bianchi: [
            { player: "LUCA", goals: 0 },
            { player: "GIAN PIERO", goals: 3 },
            { player: "STEFANO", goals: 1 },
            { player: "ALBERTO", goals: 2 },
            { player: "LUIGI", goals: 0 }
          ],
          colorati: [
            { player: "EMANUELE", goals: 4 },
            { player: "FILIPPO", goals: 2 },
            { player: "BRIAN", goals: 1 },
            { player: "PIERFRANCESCO", goals: 0 },
            { player: "GIANLUCA", goals: 1 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 3,
          bianchi: [
            { player: "GIAN PIERO", goals: 0 },
            { player: "LUIGI", goals: 1 },
            { player: "ALBERTO", goals: 5 },
            { player: "CAIO", goals: 2 },
            { player: "EDOARDO", goals: 1 }
          ],
          colorati: [
            { player: "BRIAN", goals: 2 },
            { player: "GIULIO", goals: 3 },
            { player: "FILIPPO", goals: 4 },
            { player: "ANDREA C", goals: 3 },
            { player: "PIERFRANCESCO", goals: 0 }
          ],
          autoGolBianchi: 1,
          autoGolColorati: 1
        },
        {
          giornata: 4,
          bianchi: [
            { player: "BRIAN", goals: 4 },
            { player: "ALBERTO", goals: 2 },
            { player: "ANDREA C", goals: 3 },
            { player: "LUCA", goals: 2 },
            { player: "EDOARDO", goals: 2 }
          ],
          colorati: [
            { player: "GIANLUCA", goals: 0 },
            { player: "STEFANO", goals: 3 },
            { player: "CAIO", goals: 1 },
            { player: "GIAN PIERO", goals: 1 },
            { player: "MARCO", goals: 3 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 5,
          bianchi: [
            { player: "BRIAN", goals: 1 },
            { player: "STEFANO", goals: 2 },
            { player: "GIAN PIERO", goals: 0 },
            { player: "CAIO", goals: 0 },
            { player: "PIERFRANCESCO", goals: 2 }
          ],
          colorati: [
            { player: "LUCA", goals: 3 },
            { player: "FILIPPO", goals: 0 },
            { player: "ALBERTO", goals: 2 },
            { player: "ANDREA C", goals: 0 },
            { player: "FRANCESCO", goals: 1 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 6,
          bianchi: [
            { player: "FILIPPO", goals: 2 },
            { player: "STEFANO", goals: 5 },
            { player: "RAUL", goals: 3 },
            { player: "CAIO", goals: 0 },
            { player: "LUIGI", goals: 0 }
          ],
          colorati: [
            { player: "LUCA", goals: 3 },
            { player: "GAETANO", goals: 1 },
            { player: "SAMUELE", goals: 1 },
            { player: "ALBERTO", goals: 1 },
            { player: "FRANCESCO", goals: 1 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 1
        },
        {
          giornata: 7,
          bianchi: [
            { player: "BRIAN", goals: 1 },
            { player: "STEFANO", goals: 1 },
            { player: "GIAN PIERO", goals: 1 },
            { player: "CAIO", goals: 0 },
            { player: "EDOARDO", goals: 0 }
          ],
          colorati: [
            { player: "FILIPPO", goals: 3 },
            { player: "ANDREA C", goals: 0 },
            { player: "MARCO", goals: 1 },
            { player: "RAUL", goals: 3 },
            { player: "PIERFRANCESCO", goals: 0 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 8,
          bianchi: [
            { player: "FILIPPO", goals: 3 },
            { player: "STEFANO", goals: 3 },
            { player: "LUCA", goals: 0 },
            { player: "CAIO", goals: 2 },
            { player: "EDOARDO", goals: 0 }
          ],
          colorati: [
            { player: "BRIAN", goals: 1 },
            { player: "ALBERTO", goals: 2 },
            { player: "RAUL", goals: 4 },
            { player: "GIAN PIERO", goals: 3 },
            { player: "LUIGI", goals: 0 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 9,
          bianchi: [
            { player: "BRIAN", goals: 0 },
            { player: "PIERFRANCESCO", goals: 2 },
            { player: "GIAN PIERO", goals: 0 },
            { player: "MARCO", goals: 0 },
            { player: "RAUL", goals: 0 }
          ],
          colorati: [
            { player: "FILIPPO", goals: 0 },
            { player: "CHRISTIAN", goals: 0 },
            { player: "STEFANO", goals: 0 },
            { player: "EDOARDO", goals: 0 },
            { player: "CAIO", goals: 0 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        },
        {
          giornata: 10,
          bianchi: [
            { player: "BRIAN", goals: 0 },
            { player: "PIERFRANCESCO", goals: 2 },
            { player: "GIAN PIERO", goals: 0 },
            { player: "MARCO", goals: 0 },
            { player: "RAUL", goals: 0 }
          ],
          colorati: [
            { player: "FILIPPO", goals: 0 },
            { player: "CHRISTIAN", goals: 0 },
            { player: "STEFANO", goals: 0 },
            { player: "EDOARDO", goals: 0 },
            { player: "CAIO", goals: 0 }
          ],
          autoGolBianchi: 0,
          autoGolColorati: 0
        }

      ]
    };

    // roster base: include sempre CHRISTIAN
    const basePlayers = [
      "ALBERTO","ANDREA C","ANDREA D","BRIAN","CAIO","EDOARDO","EMANUELE",
      "FILIPPO","FRANCESCO","GAETANO","GIAN PIERO","GIANLUCA","GIULIO",
      "LUCA","LUIGI","MARCO","PIERFRANCESCO","RAUL","STEFANO","CHRISTIAN"
    ];

    const state = {
      giornate: JSON.parse(JSON.stringify(initialData.giornate))
    };

    function sumGoals(arr) {
      return arr.reduce((s, p) => s + (Number(p.goals) || 0), 0);
    }

    function getAllPlayers() {
      const set = new Set(basePlayers);
      state.giornate.forEach(g => {
        g.bianchi.forEach(p => set.add(p.player));
        g.colorati.forEach(p => set.add(p.player));
      });
      return Array.from(set).sort();
    }

    // --- CLASSIFICA (stesse regole dell'Excel, PTF = PT * (1 + 0.05 * PG)) ---
    function computeStandings() {
      const map = new Map();

      function ensure(name) {
        if (!map.has(name)) {
          map.set(name, {
            Giocatore: name,
            PG: 0,
            V: 0,
            N: 0,
            P: 0,
            GF: 0,
            GS: 0,
            DR: 0,
            PT: 0,
            MPP: 0,
            MGP: 0,
            PTF: 0
          });
        }
        return map.get(name);
      }

      state.giornate.forEach(g => {
        const totB = sumGoals(g.bianchi) + (g.autoGolBianchi || 0);
        const totC = sumGoals(g.colorati) + (g.autoGolColorati || 0);
        let resB = "N", resC = "N";
        if (totB > totC) { resB = "V"; resC = "P"; }
        else if (totB < totC) { resB = "P"; resC = "V"; }

        g.bianchi.forEach(p => {
          const s = ensure(p.player);
          s.PG += 1;
          s.GF += Number(p.goals) || 0;
          s.GS += totC;
          if (resB === "V") { s.V += 1; s.PT += 3; }
          else if (resB === "N") { s.N += 1; s.PT += 1; }
          else { s.P += 1; }
        });

        g.colorati.forEach(p => {
          const s = ensure(p.player);
          s.PG += 1;
          s.GF += Number(p.goals) || 0;
          s.GS += totB;
          if (resC === "V") { s.V += 1; s.PT += 3; }
          else if (resC === "N") { s.N += 1; s.PT += 1; }
          else { s.P += 1; }
        });
      });

      const list = Array.from(map.values());
      list.forEach(p => {
        p.DR = p.GF - p.GS;
        if (p.PG > 0) {
          p.MPP = p.PT / p.PG;
          p.MGP = p.GF / p.PG;
        } else {
          p.MPP = 0;
          p.MGP = 0;
        }
        p.PTF = p.PT * (1 + 0.05 * p.PG);
      });

      list.sort((a, b) => {
        if (b.PTF !== a.PTF) return b.PTF - a.PTF;
        if (b.PT  !== a.PT)  return b.PT  - a.PT;
        if (b.GF  !== a.GF)  return b.GF  - a.GF;
        return b.DR - a.DR;
      });

      return list;
    }

    const classificaBody = document.getElementById("classificaBody");
    const podiumEl = document.getElementById("podium");
    const searchInput = document.getElementById("searchPlayer");
    let fullStandings = computeStandings();

    function renderPodium() {
      const top3 = fullStandings.slice(0, 3);
      const medals = ["ü•á", "ü•à", "ü•â"];
      const classes = ["first", "second", "third"];
      podiumEl.innerHTML = top3.map((p, i) => `
        <div class="podium-card ${classes[i]}">
          <div class="podium-medal">${medals[i]}</div>
          <div class="podium-name">${p.Giocatore}</div>
          <div class="podium-points">${p.PTF.toFixed(2)} PTF</div>
          <div class="podium-stats">${p.PT} PT ‚Ä¢ ${p.V}V ‚Ä¢ ${p.N}N ‚Ä¢ ${p.P}P</div>
        </div>
      `).join("");
    }

    function renderClassifica(list) {
      classificaBody.innerHTML = list.map((p, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td class="player-cell" data-player="${p.Giocatore}">
            <span>${p.Giocatore}</span>
          </td>
          <td>${p.PTF.toFixed(2)}</td>
          <td>${p.PT}</td>
          <td>${p.MPP.toFixed(2)}</td>
          <td>${p.MGP.toFixed(2)}</td>
          <td>${p.PG}</td>
          <td>${p.V}</td>
          <td>${p.N}</td>
          <td>${p.P}</td>
          <td>${p.GF}</td>
          <td>${p.GS}</td>
          <td>${p.DR}</td>
        </tr>
      `).join("");
    }

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      const filtered = q
        ? fullStandings.filter(p => p.Giocatore.toLowerCase().includes(q))
        : fullStandings;
      renderClassifica(filtered);
    });

    // rinomina giocatore toccando il nome
    classificaBody.addEventListener("click", (e) => {
      const cell = e.target.closest(".player-cell");
      if (!cell) return;
      const oldName = cell.dataset.player;
      const nuovo = prompt(`Nuovo nome per "${oldName}"?`, oldName);
      if (!nuovo || nuovo.trim() === "" || nuovo === oldName) return;
      const newName = nuovo.trim();

      state.giornate.forEach(g => {
        g.bianchi.forEach(p => { if (p.player === oldName) p.player = newName; });
        g.colorati.forEach(p => { if (p.player === oldName) p.player = newName; });
      });

      fullStandings = computeStandings();
      renderPodium();
      renderClassifica(fullStandings);
      renderPartite();
    });

    // PARTITE
    const partiteContainer = document.getElementById("partiteContainer");

    function renderPartite() {
      const cards = state.giornate
        .slice()
        .sort((a, b) => a.giornata - b.giornata)
        .map((g, index) => {
          const totB = sumGoals(g.bianchi) + (g.autoGolBianchi || 0);
          const totC = sumGoals(g.colorati) + (g.autoGolColorati || 0);
          let sbClass = "";
          if (totB > totC) sbClass = "w-b";
          else if (totC > totB) sbClass = "w-c";
          return `
          <div class="card" data-index="${index}">
            <div class="giornata-label">Giornata ${g.giornata}</div>
            <div class="scoreboard ${sbClass}">
              <div class="sb-side">
                <div class="sb-team-name">Bianchi</div>
              </div>
              <div class="sb-center">
                <span class="sb-score b">${totB}</span>
                <span class="sb-sep">-</span>
                <span class="sb-score c">${totC}</span>
              </div>
              <div class="sb-side">
                <div class="sb-team-name right">Colorati</div>
              </div>
            </div>
            <div class="teams-grid">
              <div>
                <div class="team-col-title">Bianchi (5)</div>
                ${g.bianchi.map(p => `
                  <div class="player-row">
                    <span class="player-name">${p.player}</span>
                    <span class="goal-badge">${p.goals}</span>
                  </div>
                `).join("")}
                ${g.autoGolBianchi ? `
                  <div class="player-row">
                    <span class="player-name">AUTO GOL</span>
                    <span class="goal-badge">${g.autoGolBianchi}</span>
                  </div>` : ""}
              </div>
              <div>
                <div class="team-col-title">Colorati (5)</div>
                ${g.colorati.map(p => `
                  <div class="player-row">
                    <span class="player-name">${p.player}</span>
                    <span class="goal-badge">${p.goals}</span>
                  </div>
                `).join("")}
                ${g.autoGolColorati ? `
                  <div class="player-row">
                    <span class="player-name">AUTO GOL</span>
                    <span class="goal-badge">${g.autoGolColorati}</span>
                  </div>` : ""}
              </div>
            </div>
            <div class="card-footer">
              <button class="small-btn btn-edit">Modifica</button>
              <button class="small-btn btn-delete">Elimina</button>
            </div>
          </div>
        `;
        }).join("");

      partiteContainer.innerHTML = cards;
    }

    partiteContainer.addEventListener("click", (e) => {
      const card = e.target.closest(".card");
      if (!card) return;
      const idx = Number(card.dataset.index);
      const g = state.giornate[idx];

      if (e.target.classList.contains("btn-delete")) {
        if (confirm(`Eliminare la giornata ${g.giornata}?`)) {
          state.giornate.splice(idx, 1);
          fullStandings = computeStandings();
          renderPodium();
          renderClassifica(fullStandings);
          renderPartite();
        }
        return;
      }

      if (e.target.classList.contains("btn-edit")) {
        openMatchModal("edit", idx);
      }
    });

    // --- MODAL LOGIC ---
    const matchModal = document.getElementById("matchModal");
    const modalBackdrop = matchModal.querySelector(".modal-backdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalGiornataNum = document.getElementById("modalGiornataNum");
    const modalBianchiRows = document.getElementById("modalBianchiRows");
    const modalColoratiRows = document.getElementById("modalColoratiRows");
    const modalAutoB = document.getElementById("modalAutoB");
    const modalAutoC = document.getElementById("modalAutoC");
    const btnModalClose = document.getElementById("modalClose");
    const btnModalCancel = document.getElementById("modalCancel");
    const btnModalSave = document.getElementById("modalSave");
    const btnNuovaGiornata = document.getElementById("btnNuovaGiornata");

    let editingIndex = null;
    let editingMode = "new";

    function buildTeamRows(container, playersArr) {
      const allPlayers = getAllPlayers();
      container.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const existing = playersArr && playersArr[i] ? playersArr[i] : { player: "", goals: 0 };
        const row = document.createElement("div");
        row.className = "modal-row";

        const sel = document.createElement("select");
        sel.className = "sel-player";
        sel.innerHTML =
          `<option value="">‚Äî Giocatore ‚Äî</option>` +
          allPlayers.map(p =>
            `<option value="${p}" ${p === existing.player ? "selected" : ""}>${p}</option>`
          ).join("");

        const inp = document.createElement("input");
        inp.type = "number";
        inp.className = "in-goals";
        inp.min = "0";
        inp.value = existing.goals || 0;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn-clear";
        btn.textContent = "‚úï";

        row.appendChild(sel);
        row.appendChild(inp);
        row.appendChild(btn);
        container.appendChild(row);
      }
    }

    function openMatchModal(mode, index) {
      editingMode = mode;
      editingIndex = index != null ? index : null;

      if (mode === "edit" && editingIndex != null) {
        const g = state.giornate[editingIndex];
        modalTitle.textContent = `Modifica giornata ${g.giornata}`;
        modalGiornataNum.textContent = g.giornata;
        modalAutoB.value = g.autoGolBianchi || 0;
        modalAutoC.value = g.autoGolColorati || 0;
        buildTeamRows(modalBianchiRows, g.bianchi);
        buildTeamRows(modalColoratiRows, g.colorati);
      } else {
        const maxG = state.giornate.length
          ? Math.max(...state.giornate.map(x => x.giornata))
          : 0;
        const next = maxG + 1;
        modalTitle.textContent = "Nuova giornata";
        modalGiornataNum.textContent = next;
        modalAutoB.value = 0;
        modalAutoC.value = 0;
        buildTeamRows(modalBianchiRows, null);
        buildTeamRows(modalColoratiRows, null);
      }

      matchModal.classList.add("show");
    }

    function closeMatchModal() {
      matchModal.classList.remove("show");
    }

    modalBackdrop.addEventListener("click", closeMatchModal);
    btnModalClose.addEventListener("click", closeMatchModal);
    btnModalCancel.addEventListener("click", closeMatchModal);

    [modalBianchiRows, modalColoratiRows].forEach(container => {
      container.addEventListener("click", e => {
        if (e.target.classList.contains("btn-clear")) {
          const row = e.target.closest(".modal-row");
          if (!row) return;
          const sel = row.querySelector(".sel-player");
          const inp = row.querySelector(".in-goals");
          sel.value = "";
          inp.value = 0;
        }
      });
    });

    function readTeam(container) {
      const rows = Array.from(container.querySelectorAll(".modal-row"));
      const team = [];
      rows.forEach(r => {
        const sel = r.querySelector(".sel-player");
        const inp = r.querySelector(".in-goals");
        const name = sel.value.trim();
        if (name) {
          team.push({
            player: name,
            goals: Number(inp.value) || 0
          });
        }
      });
      return team;
    }

    btnModalSave.addEventListener("click", () => {
      const bianchi = readTeam(modalBianchiRows);
      const colorati = readTeam(modalColoratiRows);

      if (bianchi.length !== 5 || colorati.length !== 5) {
        alert("Devi selezionare esattamente 5 giocatori per squadra.");
        return;
      }

      const allNames = [...bianchi.map(p => p.player), ...colorati.map(p => p.player)];
      const dupSet = new Set();
      const duplicates = allNames.filter((n, i) => {
        if (allNames.indexOf(n) !== i) {
          dupSet.add(n);
          return true;
        }
        return false;
      });
      if (duplicates.length > 0) {
        alert("Ogni giocatore pu√≤ comparire una sola volta nella partita.\nDuplice/i: " + Array.from(dupSet).join(", "));
        return;
      }

      const autoB = Number(modalAutoB.value) || 0;
      const autoC = Number(modalAutoC.value) || 0;

      if (editingMode === "edit" && editingIndex != null) {
        const old = state.giornate[editingIndex];
        state.giornate[editingIndex] = {
          giornata: old.giornata,
          bianchi,
          colorati,
          autoGolBianchi: autoB,
          autoGolColorati: autoC
        };
      } else {
        const maxG = state.giornate.length
          ? Math.max(...state.giornate.map(x => x.giornata))
          : 0;
        const next = maxG + 1;
        state.giornate.push({
          giornata: next,
          bianchi,
          colorati,
          autoGolBianchi: autoB,
          autoGolColorati: autoC
        });
      }

      fullStandings = computeStandings();
      renderPodium();
      renderClassifica(fullStandings);
      renderPartite();
      closeMatchModal();
    });

    btnNuovaGiornata.addEventListener("click", () => openMatchModal("new"));

    // TAB BAR
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        const viewId = tab.dataset.view;
        document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
        document.getElementById(viewId).classList.add("active");
      });
    });

    // Primo render
    renderPodium();
    renderClassifica(fullStandings);
    renderPartite();
  </script>
</body>
</html>
